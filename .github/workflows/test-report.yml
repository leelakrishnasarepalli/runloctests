name: Test Report Generation

on:
  workflow_run:
    workflows: ["Playwright Tests", "Webhook Triggered Tests"]
    types:
      - completed

jobs:
  report:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure' || github.event.workflow_run.conclusion == 'success'

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.workflow_run.id }}
        path: artifacts

    - name: Merge test reports
      run: |
        mkdir -p merged-report
        echo "# Test Execution Report" > merged-report/README.md
        echo "" >> merged-report/README.md
        echo "**Workflow**: ${{ github.event.workflow_run.name }}" >> merged-report/README.md
        echo "**Status**: ${{ github.event.workflow_run.conclusion }}" >> merged-report/README.md
        echo "**Date**: $(date)" >> merged-report/README.md
        echo "" >> merged-report/README.md

        # List all artifacts
        echo "## Artifacts Generated" >> merged-report/README.md
        find artifacts -type f -name "*.json" -o -name "*.xml" -o -name "*.html" | while read file; do
          echo "- $(basename $file)" >> merged-report/README.md
        done

        # Combine JSON results if available
        if find artifacts -name "results.json" -type f | head -1; then
          echo "" >> merged-report/README.md
          echo "## Test Results Summary" >> merged-report/README.md

          # Extract test counts from JSON files
          total_tests=0
          passed_tests=0
          failed_tests=0

          find artifacts -name "results.json" -type f | while read json_file; do
            if command -v jq >/dev/null 2>&1; then
              tests=$(jq '.stats.total // 0' "$json_file" 2>/dev/null || echo 0)
              passed=$(jq '.stats.passed // 0' "$json_file" 2>/dev/null || echo 0)
              failed=$(jq '.stats.failed // 0' "$json_file" 2>/dev/null || echo 0)

              total_tests=$((total_tests + tests))
              passed_tests=$((passed_tests + passed))
              failed_tests=$((failed_tests + failed))
            fi
          done

          echo "- Total Tests: $total_tests" >> merged-report/README.md
          echo "- Passed: $passed_tests" >> merged-report/README.md
          echo "- Failed: $failed_tests" >> merged-report/README.md
        fi

    - name: Upload merged report
      uses: actions/upload-artifact@v4
      with:
        name: test-execution-report-${{ github.event.workflow_run.id }}
        path: merged-report/
        retention-days: 90

    - name: Comment on commit
      if: github.event.workflow_run.event == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const workflowRun = context.payload.workflow_run;

          const comment = `## 🎭 Playwright Test Results

          **Workflow**: ${workflowRun.name}
          **Status**: ${workflowRun.conclusion === 'success' ? '✅ Passed' : '❌ Failed'}
          **Commit**: ${workflowRun.head_sha.substring(0, 7)}

          [View full results](${workflowRun.html_url})
          `;

          // Find the PR associated with this commit
          const pulls = await github.rest.pulls.list({
            owner,
            repo,
            state: 'open',
            head: `${owner}:${workflowRun.head_branch}`
          });

          if (pulls.data.length > 0) {
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pulls.data[0].number,
              body: comment
            });
          }